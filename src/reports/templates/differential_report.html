<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BayesInteractomics â€” Differential Interactome Report</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables Bootstrap 5 integration -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.bootstrap5.min.css">

  <style>
    body { background: #f0f2f5; font-family: 'Segoe UI', Arial, sans-serif; }
    .navbar { background: linear-gradient(135deg, #4a148c, #6a1b9a); }
    .metric-card { background: #fff; border-radius: 10px; padding: 18px 22px;
                   box-shadow: 0 1px 4px rgba(0,0,0,.12); text-align: center; }
    .metric-value { font-size: 2rem; font-weight: 700; line-height: 1.1; }
    .metric-label { font-size: .78rem; color: #6c757d; margin-top: 4px; }
    .plot-card    { background: #fff; border-radius: 10px; padding: 18px 20px;
                    box-shadow: 0 1px 4px rgba(0,0,0,.10); margin-bottom: 18px; }
    .section-title { font-size: 1rem; font-weight: 600; color: #4a148c;
                     border-left: 4px solid #6a1b9a; padding-left: 10px;
                     margin: 0 0 12px 0; }
    .static-plot  { max-width: 100%; height: auto; display: block; margin: 0 auto; border-radius: 4px; }
    .nav-tabs .nav-link       { color: #495057; font-size: .92rem; padding: .5rem 1.1rem; }
    .nav-tabs .nav-link.active{ color: #4a148c; font-weight: 600; border-bottom: 3px solid #6a1b9a; }
    #selected-banner { display: none; background: #f3e5f5; border: 1px solid #6a1b9a;
                       border-radius: 8px; padding: 8px 16px; margin-bottom: 12px; align-items: center; }
    .tab-content  { background: #f0f2f5; }
    .dataTables_wrapper { font-size: .88rem; }
    tr.dt-selected { background: #f3e5f5 !important; }
    /* Classification badges */
    .badge-gained    { background: #1565c0; color: #fff; }
    .badge-reduced   { background: #c62828; color: #fff; }
    .badge-unchanged { background: #757575; color: #fff; }
    .badge-both-neg  { background: #6a1b9a; color: #fff; }
    .badge-a-spec    { background: #e65100; color: #fff; }
    .badge-b-spec    { background: #2e7d32; color: #fff; }
    .badge-ns        { background: #e0e0e0; color: #666; }
  </style>
</head>
<body>

<!-- ===== NAVBAR ===== -->
<nav class="navbar navbar-dark py-2 px-3">
  <span class="navbar-brand fw-bold fs-5">ğŸ§¬ BayesInteractomics Â· Differential Analysis</span>
  <span class="navbar-text text-white" id="nav-subtitle" style="font-size:.9rem"></span>
  <span class="navbar-text text-white-50" id="nav-date" style="font-size:.8rem"></span>
</nav>

<div class="container-fluid py-3 px-3">

  <!-- ===== DASHBOARD ===== -->
  <div class="row g-3 mb-3" id="dashboard-row"></div>

  <!-- ===== SELECTED PROTEIN BANNER ===== -->
  <div id="selected-banner" class="d-flex gap-3 mb-2">
    <strong>Selected:</strong>
    <span id="selected-name" class="fw-semibold" style="color:#6a1b9a"></span>
    <button class="btn btn-sm btn-outline-secondary py-0" onclick="clearSelection()">âœ• Clear</button>
  </div>

  <!-- ===== TABS ===== -->
  <ul class="nav nav-tabs bg-white rounded-top px-2 pt-1" id="mainTabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-results">ğŸ“Š Results</button></li>
    <li class="nav-item" id="tab-plots-li" style="display:none"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-plots">ğŸ”¬ Plots</button></li>
  </ul>

  <div class="tab-content rounded-bottom" id="tabContent">

    <!-- ============================= TAB: RESULTS ============================= -->
    <div class="tab-pane fade show active p-3" id="tab-results">

      <!-- Interactive differential plot -->
      <div class="plot-card">
        <p class="section-title">Differential Volcano Plot
          <small class="text-muted fw-normal ms-2" style="font-size:.78rem">
            X: Î”logâ‚‚FC Â· Y: logâ‚â‚€(dBF) Â· Colour: interaction class Â· Click to highlight
          </small>
        </p>
        <div id="diff-plot" style="height:500px"></div>
      </div>

      <!-- Results table -->
      <div class="plot-card">
        <p class="section-title">Results Table</p>

        <!-- Classification legend -->
        <div class="alert alert-light border mb-3" style="font-size:.85rem">
          <strong>Classification labels</strong> â€” only proteins with significant differential evidence (diff. q &lt; threshold) receive a directional label:
          <ul class="mb-0 mt-1">
            <li><span class="badge badge-gained" style="font-size:.78rem">Gained</span> â€” Interaction detected in <em>condition A</em> (PP â‰¥ threshold) but not B, with positive Î”logâ‚‚FC.</li>
            <li><span class="badge badge-reduced" style="font-size:.78rem">Reduced</span> â€” Interaction detected in <em>condition B</em> (PP â‰¥ threshold) but not A, with negative Î”logâ‚‚FC.</li>
            <li><span class="badge badge-unchanged" style="font-size:.78rem">Unchanged</span> â€” Interaction present in both conditions with no significant directional difference, or contradictory evidence.</li>
            <li><span class="badge badge-both-neg" style="font-size:.78rem">Both negative</span> â€” Neither condition shows interaction (PP below threshold), but the differential evidence is statistically significant.</li>
            <li><span class="badge badge-a-spec" style="font-size:.78rem">Cond. A specific</span> / <span class="badge badge-b-spec" style="font-size:.78rem">Cond. B specific</span> â€” Protein present in only one condition's results.</li>
          </ul>
        </div>

        <!-- Search + export toolbar -->
        <div class="d-flex gap-2 mb-2 flex-wrap align-items-center">
          <input id="tbl-search" type="text" class="form-control form-control-sm" style="max-width:260px"
                 placeholder="ğŸ” Search proteinsâ€¦" oninput="dtSearch(this.value)">
          <button class="btn btn-sm btn-outline-primary" onclick="exportCSV()">â¬‡ Export CSV</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="resetAll()">Reset</button>
          <span class="text-muted small ms-auto" id="tbl-count"></span>
        </div>

        <!-- Filter bar -->
        <div class="d-flex flex-wrap gap-2 align-items-center mb-2 px-2 py-2 rounded"
             style="background:#f8f9fa;border:1px solid #dee2e6;font-size:.83rem">
          <span class="text-muted fw-semibold me-1">Filters:</span>

          <div class="input-group input-group-sm" style="width:auto">
            <span class="input-group-text text-muted py-0">dBF â‰¥</span>
            <input id="filter-dbf-min" type="number" class="form-control py-0"
                   style="width:72px" min="0" placeholder="â€“" oninput="applyFilters()"
                   title="Minimum differential Bayes factor">
          </div>

          <div class="input-group input-group-sm" style="width:auto">
            <span class="input-group-text text-muted py-0">diff. q â‰¤</span>
            <input id="filter-diffq-max" type="number" class="form-control py-0"
                   style="width:72px" min="0" max="1" step="0.001" placeholder="â€“"
                   oninput="applyFilters()" title="Maximum differential q-value">
            <button class="btn btn-outline-secondary btn-sm py-0 px-2"
                    onclick="setDiffQFilter(0.05)" title="Show diff. q â‰¤ 0.05">0.05</button>
            <button class="btn btn-outline-secondary btn-sm py-0 px-2"
                    onclick="setDiffQFilter(0.01)" title="Show diff. q â‰¤ 0.01">0.01</button>
          </div>

          <div class="input-group input-group-sm" style="width:auto">
            <span class="input-group-text text-muted py-0">Class.</span>
            <select id="filter-class" class="form-select py-0"
                    style="width:auto;min-width:140px" onchange="applyFilters()">
              <option value="">All</option>
              <option value="GAINED">Gained</option>
              <option value="REDUCED">Reduced</option>
              <option value="UNCHANGED">Unchanged</option>
              <option value="BOTH_NEGATIVE">Both negative</option>
              <option value="CONDITION_A_SPECIFIC">Cond. A specific</option>
              <option value="CONDITION_B_SPECIFIC">Cond. B specific</option>
            </select>
          </div>

          <div class="input-group input-group-sm" style="width:auto" id="filter-diag-group">
            <span class="input-group-text text-muted py-0">Diag.</span>
            <select id="filter-diag" class="form-select py-0"
                    style="width:auto;min-width:105px" onchange="applyFilters()"
                    title="Filter by worst diagnostic flag across A and B">
              <option value="">All</option>
              <option value="ok">âœ” OK (both)</option>
              <option value="warning">âš  Warning</option>
              <option value="fail">âœ˜ Fail</option>
            </select>
          </div>

          <div class="input-group input-group-sm" style="width:auto" id="filter-sens-group">
            <span class="input-group-text text-muted py-0">Sens. â‰¤</span>
            <input id="filter-sens-max" type="number" class="form-control py-0"
                   style="width:72px" min="0" step="0.01" placeholder="â€“"
                   oninput="applyFilters()" title="Maximum sensitivity range (worst of A/B)">
          </div>

          <button class="btn btn-sm btn-outline-danger py-0 px-2 ms-1"
                  onclick="resetFilters()" title="Clear all filters">âœ• Clear filters</button>
          <span class="text-muted ms-2" id="filter-active-badge" style="display:none">
            <span class="badge text-bg-warning" id="filter-count-badge"></span>
          </span>
        </div>
        <div class="table-responsive">
          <table id="results-table" class="table table-hover table-sm" style="width:100%">
            <thead class="table-light">
              <tr>
                <th>Protein</th>
                <th>dBF</th>
                <th>Î”logâ‚‚FC</th>
                <th>PP (A)</th>
                <th>PP (B)</th>
                <th>q (A)</th>
                <th>q (B)</th>
                <th>diff. q</th>
                <th>Classification</th>
                <th>Sens (A)</th>
                <th>Sens (B)</th>
                <th>Diag (A)</th>
                <th>Diag (B)</th>
              </tr>
            </thead>
            <tbody id="tbl-body"></tbody>
          </table>
        </div>
      </div>
    </div><!-- /tab-results -->

    <!-- ============================= TAB: STATIC PLOTS ============================= -->
    <div class="tab-pane fade p-3" id="tab-plots">
      <div id="plots-container"></div>
    </div>

  </div><!-- /tab-content -->
</div><!-- /container -->

<!-- ===== SCRIPTS (CDN) ===== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.1.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>

<!-- ===== EMBEDDED DATA ===== -->
<script>const DIFF_DATA = {{DIFF_DATA_JSON}};</script>

<!-- ===== REPORT LOGIC ===== -->
<script>
"use strict";

const D  = DIFF_DATA;
let dt   = null;
const selectedProteins = new Set();

// Classification colours (mirror Julia enum constants)
const CLS_COLOR = {
  'GAINED':               '#1565c0',
  'REDUCED':              '#c62828',
  'UNCHANGED':            '#9e9e9e',
  'BOTH_NEGATIVE':        '#6a1b9a',
  'CONDITION_A_SPECIFIC': '#e65100',
  'CONDITION_B_SPECIFIC': '#2e7d32',
};
const CLS_LABEL = {
  'GAINED':               'Gained',
  'REDUCED':              'Reduced',
  'UNCHANGED':            'Unchanged',
  'BOTH_NEGATIVE':        'Both negative',
  'CONDITION_A_SPECIFIC': 'Cond. A specific',
  'CONDITION_B_SPECIFIC': 'Cond. B specific',
};
const CLS_BADGE = {
  'GAINED':               'badge-gained',
  'REDUCED':              'badge-reduced',
  'UNCHANGED':            'badge-unchanged',
  'BOTH_NEGATIVE':        'badge-both-neg',
  'CONDITION_A_SPECIFIC': 'badge-a-spec',
  'CONDITION_B_SPECIFIC': 'badge-b-spec',
};

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  initDashboard();
  initDiffPlot();
  initTable();
  initStaticPlots();
});

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initDashboard() {
  const m = D.meta;
  document.getElementById('nav-subtitle').textContent =
    (m.condition_A || 'A') + ' vs ' + (m.condition_B || 'B') +
    '  Â·  v' + (m.package_version || '?');
  document.getElementById('nav-date').textContent = m.generated_at || '';

  const cards = [
    { val: (m.n_total  || 0).toLocaleString(), lbl: 'Proteins compared',             col: '#4a148c' },
    { val: (m.n_gained || 0).toLocaleString(), lbl: 'Gained in ' + (m.condition_A || 'A'), col: '#1565c0' },
    { val: (m.n_lost   || 0).toLocaleString(), lbl: 'Reduced in ' + (m.condition_A || 'A'), col: '#c62828' },
    { val: ((m.n_A_specific || 0) + (m.n_B_specific || 0)).toLocaleString(),
      lbl: 'Condition-specific',  col: '#e65100' },
  ];
  const row = document.getElementById('dashboard-row');
  cards.forEach(c => {
    const col = document.createElement('div');
    col.className = 'col-6 col-md-3';
    col.innerHTML = `<div class="metric-card">
      <div class="metric-value" style="color:${c.col}">${c.val}</div>
      <div class="metric-label">${c.lbl}</div></div>`;
    row.appendChild(col);
  });
}

// â”€â”€ Differential Volcano Plot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initDiffPlot() {
  const results = D.results || [];
  const m = D.meta;

  // Group by classification
  const groups = {};
  results.forEach(r => {
    const cls = r.classification || 'UNCHANGED';
    if (!groups[cls]) groups[cls] = [];
    groups[cls].push(r);
  });

  const DIFF_HT =
    '<b>%{customdata[0]}</b><br>' +
    'Class: <b>%{customdata[1]}</b><br>' +
    'dBF: <b>%{customdata[2]}</b><br>' +
    'Î”logâ‚‚FC: <b>%{customdata[3]}</b><br>' +
    'diff. q: <b>%{customdata[4]}</b><br>' +
    '<br>' +
    'PP (' + (m.condition_A || 'A') + '): %{customdata[5]}<br>' +
    'PP (' + (m.condition_B || 'B') + '): %{customdata[6]}<br>' +
    '<extra></extra>';

  const fmtBF = v => (v == null || isNaN(v)) ? 'N/A' : (v >= 1000 ? v.toExponential(2) : v.toFixed(2));
  const fmtQ  = v => (v == null || isNaN(v)) ? 'N/A' : (v < 0.001 ? v.toExponential(2) : v.toFixed(4));
  const fmt2  = v => (v == null || isNaN(v)) ? 'N/A' : v.toFixed(2);
  const fmt3  = v => (v == null || isNaN(v)) ? 'N/A' : v.toFixed(3);

  const traces = Object.entries(groups).map(([cls, data]) => ({
    x: data.map(r => r.delta_log2fc),
    y: data.map(r => r.log10_dbf),
    mode: 'markers',
    name: CLS_LABEL[cls] || cls,
    marker: { color: CLS_COLOR[cls] || '#999', size: 6, opacity: 0.75 },
    text: data.map(r => r.protein),
    customdata: data.map(r => [
      r.protein,
      CLS_LABEL[r.classification] || r.classification || 'â€“',
      fmtBF(r.dbf),
      fmt2(r.delta_log2fc),
      fmtQ(r.differential_q),
      fmt3(r.posterior_A),
      fmt3(r.posterior_B),
    ]),
    hovertemplate: DIFF_HT,
    type: 'scatter',
  }));

  const layout = {
    xaxis: {
      title: 'Î”logâ‚‚FC (' + (m.condition_A || 'A') + ' âˆ’ ' + (m.condition_B || 'B') + ')',
      zeroline: true, zerolinecolor: '#ddd',
    },
    yaxis: { title: 'logâ‚â‚€(dBF)', zeroline: true, zerolinecolor: '#ddd' },
    legend: { orientation: 'h', y: -0.18 },
    margin: { t: 10, b: 60, l: 55, r: 20 },
    shapes: [ hline(0), vline(0) ],
    hovermode: 'closest', plot_bgcolor: '#fff', paper_bgcolor: '#fff',
  };

  Plotly.newPlot('diff-plot', traces, layout, { responsive: true });
  const dpEl = document.getElementById('diff-plot');
  dpEl.on('plotly_click',    e => toggleSelected(e.points[0].customdata[0]));
  dpEl.on('plotly_selected', e => {
    if (!e || !e.points) return;
    e.points.forEach(pt => selectedProteins.add(pt.customdata[0]));
    _updateBanner(); _updateTableHighlight(); applyHighlighting();
    dt && dt.draw();
  });
}

// â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initTable() {
  const fmtBF  = v => (v == null || isNaN(v)) ? 'â€”' : (v >= 1000 ? v.toExponential(2) : v.toFixed(2));
  const fmtQ   = v => (v == null || isNaN(v)) ? 'â€”' : (v < 0.001 ? v.toExponential(2) : v.toFixed(4));
  const fmt    = (v, d) => (v == null || isNaN(v)) ? 'â€”' : v.toFixed(d);
  const flagIcon = f =>
    f === 'ok'      ? '<span title="Diagnostics OK" style="color:#2e7d32;font-size:1rem">âœ”</span>'
    : f === 'warning' ? '<span title="Diagnostic warning" style="color:#f9a825;font-size:1rem">âš </span>'
    : f === 'fail'    ? '<span title="Diagnostic failure" style="color:#c62828;font-size:1rem">âœ˜</span>'
    : '';

  // Pre-compute sensitivity tercile thresholds for background coloring
  const allSens = (D.results || []).flatMap(r =>
    [r.sensitivity_range_A, r.sensitivity_range_B].filter(v => v != null && !isNaN(v)));
  allSens.sort((a, b) => a - b);
  const sensQ33 = allSens.length > 2 ? allSens[Math.floor(allSens.length / 3)]     : null;
  const sensQ67 = allSens.length > 2 ? allSens[Math.floor(allSens.length * 2 / 3)] : null;
  const sensBg = v => {
    if (v == null || isNaN(v) || sensQ33 === null) return '';
    if (v <= sensQ33) return 'background:#e8f5e9';
    if (v >= sensQ67) return 'background:#ffebee';
    return 'background:#fff9c4';
  };

  const tbody = document.getElementById('tbl-body');
  (D.results || []).forEach(r => {
    const cls     = r.classification || '';
    const badge   = CLS_BADGE[cls] || 'badge-ns';
    const clsLbl  = CLS_LABEL[cls] || cls || 'â€“';

    const qAOrd    = (r.q_A           == null || isNaN(r.q_A))           ? 2 : r.q_A;
    const qBOrd    = (r.q_B           == null || isNaN(r.q_B))           ? 2 : r.q_B;
    const diffQOrd = (r.differential_q == null || isNaN(r.differential_q)) ? 2 : r.differential_q;
    const dbfOrd   = (r.dbf == null || isNaN(r.dbf)) ? 0 : r.dbf;
    const sAOrd    = (r.sensitivity_range_A == null || isNaN(r.sensitivity_range_A)) ? -1 : r.sensitivity_range_A;
    const sBOrd    = (r.sensitivity_range_B == null || isNaN(r.sensitivity_range_B)) ? -1 : r.sensitivity_range_B;
    const sTxtA    = (r.sensitivity_range_A == null || isNaN(r.sensitivity_range_A)) ? 'â€”' : r.sensitivity_range_A.toFixed(3);
    const sTxtB    = (r.sensitivity_range_B == null || isNaN(r.sensitivity_range_B)) ? 'â€”' : r.sensitivity_range_B.toFixed(3);

    const tr = document.createElement('tr');
    tr.dataset.protein = r.protein;
    tr.innerHTML = `
      <td><strong>${esc(r.protein)}</strong></td>
      <td data-order="${dbfOrd}">${fmtBF(r.dbf)}</td>
      <td>${fmt(r.delta_log2fc, 2)}</td>
      <td>${fmt(r.posterior_A, 3)}</td>
      <td>${fmt(r.posterior_B, 3)}</td>
      <td data-order="${qAOrd}">${fmtQ(r.q_A)}</td>
      <td data-order="${qBOrd}">${fmtQ(r.q_B)}</td>
      <td data-order="${diffQOrd}">${fmtQ(r.differential_q)}</td>
      <td><span class="badge ${badge}" style="font-size:.75rem">${esc(clsLbl)}</span></td>
      <td data-order="${sAOrd}" style="${sensBg(r.sensitivity_range_A)}">${sTxtA}</td>
      <td data-order="${sBOrd}" style="${sensBg(r.sensitivity_range_B)}">${sTxtB}</td>
      <td style="text-align:center">${flagIcon(r.diagnostic_flag_A || '')}</td>
      <td style="text-align:center">${flagIcon(r.diagnostic_flag_B || '')}</td>`;
    tr.addEventListener('click', () => toggleSelected(r.protein));
    tbody.appendChild(tr);
  });

  // Hide filter groups when the underlying data columns are absent
  const hasDiagData = (D.results || []).some(r => r.diagnostic_flag_A || r.diagnostic_flag_B);
  const hasSensData = (D.results || []).some(r =>
    (r.sensitivity_range_A != null && !isNaN(r.sensitivity_range_A)) ||
    (r.sensitivity_range_B != null && !isNaN(r.sensitivity_range_B)));
  if (!hasDiagData) document.getElementById('filter-diag-group').style.display = 'none';
  if (!hasSensData) document.getElementById('filter-sens-group').style.display = 'none';

  dt = new DataTable('#results-table', {
    paging: true, pageLength: 25,
    lengthMenu: [10, 25, 50, 100, 250],
    order: [[7, 'asc']],    // sort by diff. q ascending
    dom: 'lrtip',
    columnDefs: [{ targets: [8, 11, 12], orderable: false }],
  });

  dt.on('draw', () => {
    document.getElementById('tbl-count').textContent =
      dt.rows({ search: 'applied' }).count() + ' / ' + (D.results || []).length + ' proteins';
    applyHighlighting();
  });
  dt.draw();
}

function dtSearch(val) { dt && dt.search(val).draw(); }
function resetSearch() {
  document.getElementById('tbl-search').value = '';
  dtSearch('');
}

// â”€â”€ Column + selection filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _resultMap = null;
function _getResultMap() {
  if (!_resultMap) {
    _resultMap = {};
    (D.results || []).forEach(r => { _resultMap[r.protein] = r; });
  }
  return _resultMap;
}

// Flag severity helper (ok < warning < fail)
const _flagSev = { ok: 0, warning: 1, fail: 2 };
function _worstFlag(r) {
  const a = r.diagnostic_flag_A || '';
  const b = r.diagnostic_flag_B || '';
  if (!a && !b) return '';
  const sa = _flagSev[a] ?? -1, sb = _flagSev[b] ?? -1;
  return sa >= sb ? a : b;
}

$.fn.dataTable.ext.search.push(function(settings, data) {
  if (settings.nTable.id !== 'results-table') return true;
  const protein = data[0].replace(/<[^>]*>/g, '').trim();
  const r = _getResultMap()[protein];
  if (!r) return true;

  // Selection filter: when proteins are selected, show only those
  if (selectedProteins.size > 0 && !selectedProteins.has(protein)) return false;

  const dbfMin   = parseFloat(document.getElementById('filter-dbf-min').value);
  const diffQMax = parseFloat(document.getElementById('filter-diffq-max').value);
  const cls      = document.getElementById('filter-class').value;
  const diag     = document.getElementById('filter-diag').value;
  const sensMax  = parseFloat(document.getElementById('filter-sens-max').value);

  if (!isNaN(dbfMin)  && (r.dbf           == null || r.dbf           < dbfMin))  return false;
  if (!isNaN(diffQMax)&& (r.differential_q == null || r.differential_q > diffQMax)) return false;
  if (cls             && r.classification  !== cls)                                return false;
  if (diag) {
    const worst = _worstFlag(r);
    if (diag === 'ok'      && worst !== 'ok')                      return false;
    if (diag === 'warning' && _flagSev[worst] < _flagSev['warning']) return false;
    if (diag === 'fail'    && worst !== 'fail')                      return false;
  }
  if (!isNaN(sensMax)) {
    const maxSens = Math.max(
      r.sensitivity_range_A != null && !isNaN(r.sensitivity_range_A) ? r.sensitivity_range_A : 0,
      r.sensitivity_range_B != null && !isNaN(r.sensitivity_range_B) ? r.sensitivity_range_B : 0,
    );
    if (maxSens > sensMax) return false;
  }

  return true;
});

function applyFilters() {
  _updateFilterBadge();
  dt && dt.draw();
}

function setDiffQFilter(val) {
  document.getElementById('filter-diffq-max').value = val;
  applyFilters();
}

function resetFilters() {
  document.getElementById('filter-dbf-min').value   = '';
  document.getElementById('filter-diffq-max').value = '';
  document.getElementById('filter-class').value     = '';
  document.getElementById('filter-diag').value      = '';
  document.getElementById('filter-sens-max').value  = '';
  applyFilters();
}

function resetAll() {
  document.getElementById('tbl-search').value = '';
  resetFilters();
}

function _updateFilterBadge() {
  const vals  = ['filter-dbf-min','filter-diffq-max','filter-class','filter-diag','filter-sens-max'];
  const active = vals.filter(id => document.getElementById(id)?.value?.trim() !== '').length;
  const badge  = document.getElementById('filter-active-badge');
  if (active > 0) {
    badge.style.display = '';
    document.getElementById('filter-count-badge').textContent =
      active + ' filter' + (active > 1 ? 's' : '') + ' active';
  } else {
    badge.style.display = 'none';
  }
}

// â”€â”€ Static plots tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addStaticSection(containerId, title, imgUri) {
  const c = document.getElementById(containerId);
  const d = document.createElement('div');
  d.className = 'plot-card';
  d.innerHTML = `<p class="section-title">${esc(title)}</p>
    <img src="${imgUri}" class="static-plot" alt="${esc(title)}">`;
  c.appendChild(d);
}

function initStaticPlots() {
  const P = D.plots || {};
  const items = [
    ['volcano',        'Differential Volcano Plot'],
    ['evidence',       'Differential Evidence Plots'],
    ['scatter',        'Condition Scatter Comparison'],
    ['classification', 'Interaction Classification'],
    ['ma',             'MA Plot'],
  ];
  let hasPlots = false;
  items.forEach(([k, t]) => {
    if (P[k]) { addStaticSection('plots-container', t, P[k]); hasPlots = true; }
  });
  if (hasPlots) document.getElementById('tab-plots-li').style.display = '';
}

// â”€â”€ Selection / cross-highlighting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function _getFilterNames() {
  if (!dt) return null;
  const total = (D.results || []).length;
  const nodes = dt.rows({ search: 'applied' }).nodes().toArray();
  if (nodes.length >= total) return null;
  const s = new Set();
  nodes.forEach(n => n && s.add(n.dataset.protein));
  return s;
}

function applyHighlighting() {
  const filterNames = _getFilterNames();
  const hasFilter   = filterNames !== null;
  const hasSel      = selectedProteins.size > 0;

  const el = document.getElementById('diff-plot');
  if (!el || !el.data) return;
  const opacities = [], sizes = [];
  el.data.forEach(trace => {
    const texts = trace.text || [];
    opacities.push(texts.map(n => {
      const sel = hasSel && selectedProteins.has(n);
      const vis = !hasFilter || filterNames.has(n);
      if (sel)  return 1.0;
      if (!vis) return 0.05;
      return hasSel ? 0.18 : 0.75;
    }));
    sizes.push(texts.map(n => {
      const sel = hasSel && selectedProteins.has(n);
      const vis = !hasFilter || filterNames.has(n);
      if (sel)  return 14;
      if (!vis) return 3;
      return 6;
    }));
  });
  Plotly.restyle('diff-plot', { 'marker.opacity': opacities, 'marker.size': sizes });
}

function _updateBanner() {
  const banner = document.getElementById('selected-banner');
  const n = selectedProteins.size;
  if (n === 0) { banner.style.display = 'none'; return; }
  banner.style.display = 'flex';
  const names = [...selectedProteins];
  document.getElementById('selected-name').textContent =
    n === 1 ? names[0] : n + ' proteins: ' + names.slice(0, 3).join(', ') + (n > 3 ? ' â€¦' : '');
}

function _updateTableHighlight() {
  document.querySelectorAll('#tbl-body tr').forEach(tr => {
    tr.style.background = selectedProteins.has(tr.dataset.protein) ? '#f3e5f5' : '';
  });
}

function toggleSelected(protein) {
  if (selectedProteins.has(protein)) {
    selectedProteins.delete(protein);
  } else {
    selectedProteins.add(protein);
  }
  _updateBanner();
  _updateTableHighlight();
  applyHighlighting();
  dt && dt.draw();
}

function clearSelection() {
  selectedProteins.clear();
  _updateBanner();
  _updateTableHighlight();
  applyHighlighting();
  dt && dt.draw();
}

// â”€â”€ CSV export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  const m = D.meta || {};
  const hdr = ['Protein','dbf','delta_log2fc',
               'posterior_A','posterior_B','q_A','q_B','differential_q','classification'];
  const rows = (D.results || []).map(r =>
    [r.protein, r.dbf, r.delta_log2fc,
     r.posterior_A, r.posterior_B, r.q_A, r.q_B, r.differential_q, r.classification].join(','));
  const csv  = [hdr.join(','), ...rows].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url  = URL.createObjectURL(blob);
  const a    = Object.assign(document.createElement('a'), {
    href: url,
    download: `differential_${m.condition_A || 'A'}_vs_${m.condition_B || 'B'}.csv`
  });
  a.click();
  URL.revokeObjectURL(url);
}

// â”€â”€ Shape helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hline(y, color = '#ccc') {
  return { type:'line', xref:'paper', x0:0, x1:1, y0:y, y1:y,
           line:{ color, dash:'dash', width:1 } };
}
function vline(x, color = '#ccc') {
  return { type:'line', yref:'paper', x0:x, x1:x, y0:0, y1:1,
           line:{ color, dash:'dash', width:1 } };
}

// â”€â”€ HTML escaping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
